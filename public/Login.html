<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
    <link rel="stylesheet" href="/stylesLG.css">
    <title>Iniciar SesiÃ³n</title>
    <style>
        /* Estilos para mensajes */
        .message {
            padding: 12px 16px;
            border-radius: 8px;
            margin-bottom: 16px;
            font-size: 14px;
            display: none;
            text-align: center;
        }

        .message.success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .message.error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        /* Loading states */
        button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .form-input:invalid {
            border-color: #ff6b6b;
        }

        .form-input:valid {
            border-color: #3b49df;
        }
    </style>
</head>
<body>
<!-- =====================================================================
        SECCION 1: MINIBAR
===================================================================== -->
    <aside class="minibar" id="minibar">
        <nav class="minibar__nav">
            <ul class="minibar__list">

                <!-- Item: DEV Community 1 -->
                <li class="minibar__item minibar__item--active">
                    <a href="#" class="minibar__link" data-preview="DEV Community">
                        <img src="/IMAGENES/image-no-exists.png" alt="DEV Community" class="minibar__image">
                    </a>
                    <article class="minibar__preview">
                        <header class="preview__header">
                            <img src="/IMAGENES/dev-header.png" alt="DEV Community Header" class="preview__header-image">
                        </header>
                        <section class="preview__content">
                            <h3 class="preview__title">Forem Feed</h3>
                            <p class="preview__description">
                                A space to discuss and keep up with software development and manage your software
                                career.
                            </p>
                            <button class="preview__btn">Follow</button>
                        </section>
                    </article>
                </li>

                <!-- Item: DEV Community 2 -->
                <li class="minibar__item minibar__item--active">
                    <a href="#" class="minibar__link" data-preview="DEV Community">
                        <img src="/IMAGENES/dev-black.png" alt="DEV Community" class="minibar__image">
                    </a>
                    <article class="minibar__preview">
                        <header class="preview__header">
                            <img src="/IMAGENES/dev-header.png" alt="DEV Community Header" class="preview__header-image">
                        </header>
                        <section class="preview__content">
                            <h3 class="preview__title">DEV Community</h3>
                            <p class="preview__description">
                                A space to discuss and keep up with software development and manage your software
                                career.
                            </p>
                            <button class="preview__btn">Follow</button>
                        </section>
                    </article>
                </li>

                <!-- Los demÃ¡s items de la minibar se mantienen igual -->
                <!-- ... (mantener todos los items existentes) ... -->

            </ul>
        </nav>

        <!-- BOTONES ADICIONALES -->
        <section class="minibar__footer">
            <button class="minibar__action-btn" title="Add community">
                +
            </button>
            <button class="minibar__action-btn" title="More options">
                â‹¯
            </button>
        </section>
    </aside>

    <!-- ===== SECCION 2:MAIN LOGIN CONTENT ===== -->
    <main class="login-container">
        <figure style="text-align: center; margin-bottom: 20px;">
            <img src="/IMAGENES/dev-black.png" alt="DEV Logo" width="60" height="60">
        </figure>

        <header class="login-header">
            <h1>Ãšnete a nuestra Comunidad</h1>
            <p>Nuestra comunidad tiene mÃ¡s de <span class="highlight">3,152,305</span> desarrolladores increÃ­bles</p>
        </header>

        <section class="login-card">
            <section class="social-login">
                <button type="button" class="social-btn apple">
                    <i class="fab fa-apple" aria-hidden="true" style="margin-right: 8px;"></i>
                    Continuar con Apple
                </button>
                <button type="button" class="social-btn facebook" onclick="window.location.href='/auth/facebook'">
                    <i class="fab fa-facebook" aria-hidden="true" style="margin-right: 8px;"></i>
                    Continuar con Facebook
                </button>
                <button type="button" class="social-btn github" onclick="window.location.href='/auth/github'">
                    <i class="fab fa-github" aria-hidden="true" style="margin-right: 8px;"></i>
                    Continuar con GitHub
                </button>
                <button type="button" class="social-btn twitter">
                    <i class="fab fa-twitter" aria-hidden="true" style="margin-right: 8px;"></i>
                    Continuar con Twitter
                </button>
                <a href="/auth/google" class="social-google">
                    <button type="button" class="social-btn google">
                        <i class="fab fa-google" aria-hidden="true" style="margin-right: 8px;"></i>
                        Continuar con Google
                    </button>
                </a>
                <button type="button" class="social-btn linkedin">
                    <i class="fab fa-linkedin" aria-hidden="true" style="margin-right: 8px;"></i>
                    Continuar con LinkedIn
                </button>
            </section>

            <hr class="divider">

            <form id="loginForm">
                <output id="message" class="message"></output>

                <fieldset class="form-section">
                    <label class="form-label" for="username">USUARIO O EMAIL</label>
                    <input type="text" id="username" name="username" class="form-input" required 
                           placeholder="Ingresa tu usuario o email">
                    <small class="form-help">Puedes usar tu nombre de usuario o direcciÃ³n de email</small>
                </fieldset>

                <fieldset class="form-section">
                    <label class="form-label" for="password">CONTRASEÃ‘A</label>
                    <input type="password" id="password" name="password" class="form-input" required 
                           placeholder="Ingresa tu contraseÃ±a" minlength="6">
                    <small class="form-help">MÃ­nimo 6 caracteres</small>
                </fieldset>

                <p style="text-align: right; margin-bottom: 16px;">
                    <a href="#" style="font-size: 14px; color: #3b49df; text-decoration: none;">Â¿Olvidaste tu contraseÃ±a?</a>
                </p>

                <menu class="remember-me">
                    <li>
                        <input type="checkbox" id="remember">
                        <label for="remember">Recordarme</label>
                    </li>
                </menu>

                <button type="submit" class="login-btn" id="submitBtn">INICIAR SESIÃ“N</button>

                <nav class="register-link">
                    <a href="signup.html">Â¿No tienes una cuenta? RegÃ­strate</a>
                </nav>
            </form>

            <footer class="terms">
                Al iniciar sesiÃ³n, aceptas nuestra <a href="#">polÃ­tica de privacidad</a> y <a href="#">tÃ©rminos de uso</a>
            </footer>
        </section>
    </main>

    <script>
        // =====================================================================
        // SECCION 3: LOGIN FUNCTIONALITY - Funcionalidad de Login Mejorada CON JWT
        // =====================================================================
        document.addEventListener('DOMContentLoaded', function() {
            const loginForm = document.getElementById('loginForm');
            const messageOutput = document.getElementById('message');
            const submitBtn = document.getElementById('submitBtn');
            
            console.log('ðŸ”§ Inicializando sistema de login con JWT...');

            // FUNCIÃ“N: Mostrar mensajes al usuario
            function showMessage(message, type = 'error') {
                messageOutput.textContent = message;
                messageOutput.className = `message ${type}`;
                messageOutput.style.display = 'block';
                
                // Auto-ocultar mensajes de Ã©xito despuÃ©s de 3 segundos
                if (type === 'success') {
                    setTimeout(() => {
                        messageOutput.style.display = 'none';
                    }, 3000);
                }
            }

            // FUNCIÃ“N: Validar formulario antes del envÃ­o
            function validateForm(formData) {
                const username = formData.get('username');
                const password = formData.get('password');

                if (!username || !username.trim()) {
                    showMessage('Por favor, ingresa tu usuario o email');
                    return false;
                }

                if (!password || !password.trim()) {
                    showMessage('Por favor, ingresa tu contraseÃ±a');
                    return false;
                }

                if (password.length < 6) {
                    showMessage('La contraseÃ±a debe tener al menos 6 caracteres');
                    return false;
                }

                return true;
            }

            // FUNCIÃ“N: Habilitar/deshabilitar botÃ³n de envÃ­o
            function setLoadingState(loading) {
                if (loading) {
                    submitBtn.disabled = true;
                    submitBtn.textContent = 'Iniciando sesiÃ³n...';
                    submitBtn.style.opacity = '0.7';
                } else {
                    submitBtn.disabled = false;
                    submitBtn.textContent = 'INICIAR SESIÃ“N';
                    submitBtn.style.opacity = '1';
                }
            }

            // EVENTO: EnvÃ­o del formulario de login
            loginForm.addEventListener('submit', async function(e) {
                e.preventDefault();
                console.log('ðŸ“¤ Enviando formulario de login con JWT...');

                // Ocultar mensajes anteriores
                messageOutput.style.display = 'none';

                // Obtener datos del formulario
                const formData = new FormData(loginForm);
                
                // Validar formulario
                if (!validateForm(formData)) {
                    return;
                }

                // Mostrar loading en el botÃ³n
                setLoadingState(true);

                try {
                    console.log('ðŸ”„ Enviando solicitud de autenticaciÃ³n con JWT...');
                    
                    const response = await fetch('/authenticate', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            username: formData.get('username').trim(),
                            password: formData.get('password'),
                            device: 'web'
                        })
                    });

                    const result = await response.json();
                    console.log('ðŸ“¥ Respuesta del servidor:', result);

                    if (result.success) {
                        // ðŸ”¥ GUARDAR TOKEN JWT EN LOCALSTORAGE
                        if (result.token) {
                            localStorage.setItem('jwtToken', result.token);
                            console.log('âœ… Token JWT guardado en localStorage:', result.token.substring(0, 20) + '...');
                        }
                        
                        showMessage('âœ… ' + result.message, 'success');
                        console.log('ðŸ”„ Redirigiendo a /index...');
                        
                        // Redirigir despuÃ©s de un breve delay para mostrar el mensaje
                        setTimeout(() => {
                            window.location.href = result.redirect || '/index';
                        }, 1000);
                    } else {
                        showMessage('âŒ ' + result.error);
                        console.error('Error de autenticaciÃ³n:', result.error);
                    }

                } catch (error) {
                    console.error('âŒ Error en la solicitud:', error);
                    showMessage('âŒ Error de conexiÃ³n. Intenta nuevamente.');
                } finally {
                    // Restaurar botÃ³n
                    setLoadingState(false);
                }
            });

            // EVENTO: Limpiar mensajes cuando el usuario empiece a escribir
            const inputs = loginForm.querySelectorAll('input');
            inputs.forEach(input => {
                input.addEventListener('input', () => {
                    messageOutput.style.display = 'none';
                    // ValidaciÃ³n en tiempo real
                    if (input.type === 'password' && input.value.length > 0 && input.value.length < 6) {
                        input.style.borderColor = '#ff6b6b';
                    } else if (input.value.length > 0) {
                        input.style.borderColor = '#3b49df';
                    }
                });
            });

            // EVENTO: Prevenir envÃ­o mÃºltiple
            let isSubmitting = false;
            loginForm.addEventListener('submit', function(e) {
                if (isSubmitting) {
                    e.preventDefault();
                    return;
                }
                isSubmitting = true;
                setTimeout(() => {
                    isSubmitting = false;
                }, 2000);
            });

            // Verificar si ya hay un token guardado
            const existingToken = localStorage.getItem('jwtToken');
            if (existingToken) {
                console.log('ðŸ”‘ Token JWT encontrado en localStorage');
                // Opcional: Verificar si el token es vÃ¡lido
                fetch('/api/auth/verify', {
                    headers: {
                        'Authorization': `Bearer ${existingToken}`
                    }
                })
                .then(response => {
                    if (response.ok) {
                        console.log('âœ… Token JWT vÃ¡lido encontrado');
                        // El usuario ya estÃ¡ autenticado, podrÃ­as redirigir automÃ¡ticamente
                        // window.location.href = '/index';
                    } else {
                        console.log('âŒ Token JWT invÃ¡lido, limpiando...');
                        localStorage.removeItem('jwtToken');
                    }
                })
                .catch(error => {
                    console.error('Error verificando token:', error);
                    localStorage.removeItem('jwtToken');
                });
            }

            console.log('âœ… Sistema de login con JWT inicializado correctamente');
        });
    </script>
    <script src="/scriptsLG.js"></script>
</body>
</html>